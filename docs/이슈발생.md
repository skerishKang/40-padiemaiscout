# GrantScout Cloud Functions PoC 이슈 발생 및 해결 과정 상세 기록

## 1. 목표 및 배경
- Firebase Cloud Functions를 활용해 PDF 파일을 분석하고 Firestore에 결과를 저장하는 PoC(Proof of Concept) 기능을 실제 환경에서 테스트하는 것이 목표임.
- 초기에는 로컬 Firebase 에뮬레이터 환경에서 개발 및 테스트를 시도함.

## 2. 로컬 에뮬레이터 환경 문제
- 에뮬레이터 실행 시 'No emulators to start' 오류가 반복적으로 발생함.
- 폴더 구조, firebase.json, functions/package.json, index.js 등 모든 설정을 점검 및 정리함.
- Node.js 버전(18, 20, 22), firebase-functions 버전(4.x, 6.x), 의존성, 환경변수 등 다양한 원인에 대해 시도함.
- npm install, nvm(Node Version Manager)로 Node.js 버전 전환, 캐시 삭제, firebase-tools 재설치 등 모든 기본적인 해결책을 적용함.
- 그래도 에뮬레이터가 정상적으로 실행되지 않아, 실제 Firebase 환경에 직접 배포하는 전략으로 전환함. 

## 3. 실제 Firebase Functions 배포 시도 및 권한 이슈
- firebase deploy --only functions 명령어로 실제 Firebase 환경에 Cloud Functions를 배포 시도함.
- 코드 업로드는 성공했으나, Cloud Build 서비스 계정의 IAM(권한) 문제로 함수 생성(Build) 단계에서 실패함.
- 오류 메시지: 'can not be accessed by IAM. Please ensure it exists.' (Cloud Build 서비스 계정에 필요한 권한이 없음)
- Google Cloud Console > IAM에서 Cloud Build 서비스 계정(숫자@cloudbuild.gserviceaccount.com)이 보이지 않음.
- Cloud Build API는 이미 활성화된 상태임을 확인함.
- Google Cloud가 서비스 계정을 자동 생성/반영하는 데 시간이 걸릴 수 있어, 5~10분 대기 및 IAM 새로고침, 재배포 등을 반복 시도함.
- 현재는 Cloud Build 서비스 계정이 IAM 목록에 나타나기를 대기 중이며, 생성 즉시 '편집자' 역할을 부여할 예정임. 

## 4. 환경 정보 및 참고 사항
- OS: Windows, Node.js 18/20/22(nvm으로 전환), Firebase CLI v14.2.2, firebase-functions v4.4.1, firebase-admin v11.11.1
- 주요 명령어: firebase emulators:start, firebase deploy --only functions, nvm install/use, npm install 등
- 참고 로그: functions deploy had errors with the following functions: extractPdfText(us-central1), IAM can not be accessed by ...
- 참고 문서: https://cloud.google.com/iam/docs/access-change-propagation, https://console.cloud.google.com/apis/library/cloudbuild.googleapis.com
- 향후 조치: Cloud Build 서비스 계정이 생성되면 '편집자' 역할을 부여하고, 5~10분 후 다시 배포를 시도할 예정임.
- 이슈가 해결되면, 실제 PDF 업로드 및 Firestore/로그 확인을 통해 PoC 기능의 정상 동작 여부를 검증할 계획임. 

알겠습니다. 지금까지 진행된 GrantScout 프로젝트의 PDF 분석 PoC 개발 및 테스트 과정에서 겪었던 상황을 최대한 자세히 요약해 드리겠습니다.

**GrantScout 프로젝트 상세 현황 요약 (PDF 분석 PoC 단계 중심)**

**1. 프로젝트 개요 및 완료된 기반:**

*   **목표:** Flutter 웹 앱으로, 사용자가 업로드한 국가지원사업 공고 파일(PDF 등)을 분석하고, 사용자 프로필과 매칭시켜 적합한 사업을 추천하는 서비스 개발.
*   **기술 스택:** Flutter (Web), Firebase (Auth, Firestore, Storage, Cloud Functions), JS Interop (웹 다운로드용).
*   **완료된 기능 (기반):** Firebase 프로젝트 연동, Google 계정 및 테스트 계정 인증, 파일 다중 선택(중복 방지), 선택된 파일을 Firebase Storage에 업로드(MIME 타입 지정, `uploads/{userId}/파일명_타임스탬프` 경로), 업로드 성공 시 파일 메타데이터를 Firestore `uploaded_files` 컬렉션에 저장(Batch Write, `analysisStatus='uploaded'`), Firestore 데이터 기반 실시간 파일 목록 UI 표시(오류 처리 포함), 목록에서 파일 삭제(Firestore 문서 및 Storage 파일 동시 삭제, 확인 대화상자), 목록에서 파일 다운로드(JS Interop 활용 웹 다운로드, 실시간 URL 획득) 기능까지 웹 파일 관리의 기본 흐름을 안정적으로 구축 완료.

**2. 현재 집중 단계: PDF 분석 PoC(Proof of Concept) 개발**

*   프로젝트의 핵심 가치인 **업로드된 PDF 파일의 내용 분석** 기능 구현의 첫 단계로, 기술적 가능성을 검증하기 위한 PoC 개발에 착수.
*   **목표:** Firebase Storage에 업로드된 PDF 파일의 텍스트를 추출하여 Firestore에 저장하는 자동화된 파이프라인 구축 및 검증.

**3. PoC 설계 및 코드 구현:**

*   **아키텍처:** 백엔드 처리를 위해 Firebase Cloud Functions 사용 결정 (Node.js, JavaScript 환경).
*   **트리거:** Firebase Cloud Storage의 특정 경로(`uploads/{userId}/...`)에 PDF 파일 업로드가 완료(`finalize`)될 때 자동으로 함수가 실행되도록 Storage 트리거 설정.
*   **핵심 로직:**
    1.  트리거된 이벤트 정보(파일 경로, 버킷 등) 수신.
    2.  `@google-cloud/storage` SDK를 사용하여 해당 PDF 파일을 Cloud Function 환경으로 다운로드.
    3.  다운로드한 파일 데이터를 `pdf-parse` 라이브러리를 사용하여 텍스트 추출 시도.
    4.  추출 성공 시: Firestore의 `uploaded_files` 컬렉션 내 해당 파일 문서에 `analysisStatus`를 `'text_extracted_success'`로, `extractedText` 필드에 추출된 텍스트를 저장 (문서 업데이트, `merge:true` 사용).
    5.  추출 실패 시: `analysisStatus`를 `'text_extracted_failed'`로 업데이트.
    6.  성공/실패 로깅 (`functions.logger`).
*   **코드 작성:** 위 로직을 수행하는 `extractPdfText` 함수를 `functions/index.js` 파일에 작성 완료. 필요한 라이브러리 (`firebase-functions`, `firebase-admin`, `@google-cloud/storage`, `pdf-parse`) `require` 구문 포함.

**4. 테스트 계획 (초기): 로컬 Firebase 에뮬레이터 사용**

*   빠른 개발 속도, 비용 절감, 안전한 테스트 환경을 위해 로컬 Firebase 에뮬레이터(Functions, Storage, Firestore)를 사용하여 PoC 코드를 테스트하기로 계획.

**5. 로컬 에뮬레이터 설정 과정의 지속적인 문제 발생 및 해결 시도:**

*   **최초 문제:** 프로젝트 루트에서 `firebase emulators:start --only functions,storage,firestore` 실행 시 `Error: No emulators to start, run firebase init emulators to get started.` 오류 발생.
*   **`firebase init emulators` 실행:** 명령어 실행 및 Functions, Firestore, Storage 에뮬레이터 선택, 포트 설정, UI 활성화, 에뮬레이터 다운로드까지 성공적으로 완료 (`Firebase initialization complete!` 메시지 확인). 하지만 에뮬레이터 시작 오류는 계속됨.
*   **기본 설정 및 구조 점검 (모두 정상 확인):**
    *   `firebase.json`: `functions.source` 경로 및 `emulators` 설정 내용 점검 완료.
    *   `.firebaserc`: `default` 프로젝트 ID 연결 상태 점검 완료.
    *   폴더 구조: `functions` 폴더 중첩 문제 해결 및 최종 구조 확인 완료.
    *   명령어 실행 위치: 프로젝트 루트 디렉토리에서 실행하는 것 재차 확인.
*   **라이브러리 호환성 문제 발생 및 해결:**
    *   에뮬레이터가 잠시 시작되었으나 함수 로드 시 `TypeError: functions.storage.object is not a function` 오류 발생 확인. → `firebase-functions` 최신 버전(v6+)과 코드(v4 구문) 간 호환성 문제 진단.
    *   해결책으로 PoC 코드 유지를 위해 라이브러리 버전 다운그레이드 결정.
    *   `npm install firebase-functions@4.4.1 firebase-admin@12.6.0` 실행 시 `ERESOLVE` 의존성 충돌 발생 (peer dependency 문제). → `firebase-admin` 요구 버전 불일치 확인.
    *   `npm install firebase-functions@4.4.1 firebase-admin@11.11.1` 로 수정하여 1차 충돌 해결.
    *   `pdf-parse`, `@google-cloud/storage` 설치 시도 중 `firebase-functions-test` 와의 `ERESOLVE` 충돌 재발생. → `firebase-functions-test` 요구 버전(>=4.9.0)과 설치된 `firebase-functions`(4.4.1) 불일치 확인.
    *   `npm install pdf-parse @google-cloud/storage firebase-functions-test@^3.0.0` 로 `firebase-functions-test` 버전을 호환되는 버전으로 지정하여 최종 의존성 충돌 해결 및 필수 라이브러리 설치 완료.
*   **환경 및 CLI 도구 점검 (오류 지속):**
    *   Firebase CLI 완전 재설치 (`npm uninstall/install -g`, `cache clean`) 및 재로그인 시도.
    *   Firebase 로컬 사용자 설정 파일(`%USERPROFILE%\.config\configstore\firebase-tools.json`) 삭제 및 재로그인 시도.
    *   프로젝트 루트의 `.firebase` 숨김 폴더 삭제 시도.
    *   관리자 권한으로 터미널 실행 시도.
    *   `firebase.json` 파일 재생성 (내용 복사/붙여넣기) 시도.
    *   `firebase --debug emulators:start ...` 로 상세 로그 확인 시도 (특이점 미발견).
    *   환경 변수 충돌 가능성 고려 (직접 확인 및 수정은 진행 안 함).
    *   Node.js 버전(v22) 문제 가능성 고려 (LTS 버전(v20) 전환은 진행 안 함).

**6. 현재 상황 및 결정:**

*   위의 모든 문제 해결 노력에도 불구하고, 프로젝트 루트에서 `firebase emulators:start --only functions,storage,firestore` 실행 시 `Error: No emulators to start` 오류가 해결되지 않음.
*   로컬 에뮬레이터 환경 설정에 예상치 못한 심각한 문제가 있는 것으로 판단하고, 더 이상의 시간 소모를 막기 위해 로컬 테스트 방식을 포기하기로 결정.

**7. 다음 단계: 실제 Firebase 환경 배포 및 테스트**

*   작성 완료된 PoC Cloud Function 코드를 실제 Firebase 프로젝트 환경에 직접 배포하여 테스트를 진행하기로 결정.
*   **구체적 액션:** 프로젝트 루트 디렉토리에서 `firebase deploy --only functions` 명령어를 실행하고, 배포 완료 후 Flutter 웹 앱을 통해 PDF 파일을 업로드하여 Firebase 콘솔(Firestore 데이터 및 Cloud Functions 로그)에서 실제 동작 결과를 확인할 예정.

이것이 현재까지의 상세한 상황 요약입니다. 에뮬레이터 문제 해결 과정이 길었지만, 코드 자체는 준비되었고 테스트 방식만 변경하여 다음 단계로 나아가는 상황입니다.

netstat -ano | findstr :8080
cd grantscout_app
flutter run -d chrome --web-port 5000